document.write('<link rel="stylesheet" href="https://gist.github.com/stylesheets/gist/embed.css"/>')





document.write('<div id=\"gist-1193089\" class=\"gist\">\n  \n  \n    \n      \n        \n        \n\n        <div class=\"gist-file\">\n          <div class=\"gist-data gist-syntax\">\n            \n            \n            \n              <div class=\"gist-highlight\"><pre><div class=\'line\' id=\'LC1\'><span class=\"nd\">@Component<\/span><\/div><div class=\'line\' id=\'LC2\'><span class=\"kd\">public<\/span> <span class=\"kd\">class<\/span> <span class=\"nc\">SignatureVerifikasjonsFilter<\/span> <span class=\"kd\">implements<\/span> <span class=\"n\">ContainerRequestFilter<\/span> <span class=\"o\">{<\/span><\/div><div class=\'line\' id=\'LC3\'><br/><\/div><div class=\'line\' id=\'LC4\'>	<span class=\"nd\">@Override<\/span><\/div><div class=\'line\' id=\'LC5\'>	<span class=\"kd\">public<\/span> <span class=\"n\">ContainerRequest<\/span> <span class=\"nf\">filter<\/span><span class=\"o\">(<\/span><span class=\"kd\">final<\/span> <span class=\"n\">ContainerRequest<\/span> <span class=\"n\">request<\/span><span class=\"o\">)<\/span> <span class=\"o\">{<\/span><\/div><div class=\'line\' id=\'LC6\'><br/><\/div><div class=\'line\' id=\'LC7\'>		<span class=\"c1\">// Henter ut id&#39;en brukeren utgir seg for å være<\/span><\/div><div class=\'line\' id=\'LC8\'>		<span class=\"n\">String<\/span> <span class=\"n\">userIdHeader<\/span> <span class=\"o\">=<\/span> <span class=\"n\">request<\/span><span class=\"o\">.<\/span><span class=\"na\">getHeaderValue<\/span><span class=\"s\">&quot;X-Vendor-Userid&quot;<\/span><span class=\"o\">);<\/span><\/div><div class=\'line\' id=\'LC9\'><br/><\/div><div class=\'line\' id=\'LC10\'>		<span class=\"c1\">// Henter ut Bruker-objektet<\/span><\/div><div class=\'line\' id=\'LC11\'>		<span class=\"n\">User<\/span> <span class=\"n\">user<\/span> <span class=\"o\">=<\/span> <span class=\"n\">getUserFromId<\/span><span class=\"o\">(<\/span><span class=\"n\">userIdHeader<\/span><span class=\"o\">);<\/span><\/div><div class=\'line\' id=\'LC12\'><br/><\/div><div class=\'line\' id=\'LC13\'>		<span class=\"c1\">// Henter ut sertifikatet til brukeren<\/span><\/div><div class=\'line\' id=\'LC14\'>		<span class=\"n\">Sertifikat<\/span> <span class=\"n\">sertifikat<\/span> <span class=\"o\">=<\/span> <span class=\"n\">user<\/span><span class=\"o\">.<\/span><span class=\"na\">getSertifikat<\/span><span class=\"o\">();<\/span><\/div><div class=\'line\' id=\'LC15\'><br/><\/div><div class=\'line\' id=\'LC16\'>		<span class=\"c1\">// Sjekk evt. revokering av sertifikatet<\/span><\/div><div class=\'line\' id=\'LC17\'>		<span class=\"n\">sertifikat<\/span><span class=\"o\">.<\/span><span class=\"na\">sjekkRevokering<\/span><span class=\"o\">();<\/span><\/div><div class=\'line\' id=\'LC18\'><br/><\/div><div class=\'line\' id=\'LC19\'>		<span class=\"c1\">// Generer kanonisk streng som skulle vært signert<\/span><\/div><div class=\'line\' id=\'LC20\'>		<span class=\"n\">String<\/span> <span class=\"n\">stringToSign<\/span> <span class=\"o\">=<\/span> <span class=\"n\">genererKanoniskStreng<\/span><span class=\"o\">(<\/span><span class=\"n\">request<\/span><span class=\"o\">);<\/span><\/div><div class=\'line\' id=\'LC21\'><br/><\/div><div class=\'line\' id=\'LC22\'>		<span class=\"c1\">// Hent ut signatur fra header<\/span><\/div><div class=\'line\' id=\'LC23\'>		<span class=\"n\">String<\/span> <span class=\"n\">signatur<\/span> <span class=\"o\">=<\/span> <span class=\"n\">request<\/span><span class=\"o\">.<\/span><span class=\"na\">getHeaderValue<\/span><span class=\"s\">&quot;X-Vendor-Signature&quot;<\/span><span class=\"o\">);<\/span><\/div><div class=\'line\' id=\'LC24\'><br/><\/div><div class=\'line\' id=\'LC25\'>		<span class=\"c1\">// Sjekker at signaturen er gyldig<\/span><\/div><div class=\'line\' id=\'LC26\'>		<span class=\"kt\">boolean<\/span> <span class=\"n\">verifisert<\/span> <span class=\"o\">=<\/span> <span class=\"n\">sertifikat<\/span><span class=\"o\">.<\/span><span class=\"na\">verifiserSignatur<\/span><span class=\"o\">(<\/span><span class=\"n\">stringToSign<\/span><span class=\"o\">,<\/span> <span class=\"n\">Base64<\/span><span class=\"o\">.<\/span><span class=\"na\">decodeBase64<\/span><span class=\"o\">(<\/span><span class=\"n\">signatur<\/span><span class=\"o\">.<\/span><span class=\"na\">getBytes<\/span><span class=\"o\">()));<\/span><\/div><div class=\'line\' id=\'LC27\'><br/><\/div><div class=\'line\' id=\'LC28\'>		<span class=\"k\">if<\/span> <span class=\"o\">(!<\/span><span class=\"n\">verifisert<\/span><span class=\"o\">)<\/span> <span class=\"o\">{<\/span><\/div><div class=\'line\' id=\'LC29\'>			<span class=\"c1\">// Kast Exception - signaturverifikasjon feilet!<\/span><\/div><div class=\'line\' id=\'LC30\'>		<span class=\"o\">}<\/span><\/div><div class=\'line\' id=\'LC31\'><br/><\/div><div class=\'line\' id=\'LC32\'>		<span class=\"c1\">// Dersom vi kommer hit, så er signaturen verifisert<\/span><\/div><div class=\'line\' id=\'LC33\'>		<span class=\"c1\">// Vi trenger derfor ikke tenke noe mer på dette i koden ellers!<\/span><\/div><div class=\'line\' id=\'LC34\'>		<span class=\"k\">return<\/span> <span class=\"n\">request<\/span><span class=\"o\">;<\/span><\/div><div class=\'line\' id=\'LC35\'>	<span class=\"o\">}<\/span><\/div><div class=\'line\' id=\'LC36\'><br/><\/div><div class=\'line\' id=\'LC37\'><span class=\"o\">}<\/span><\/div><\/pre><\/div>\n            \n          <\/div>\n\n          <div class=\"gist-meta\">\n            <a href=\"https://gist.github.com/raw/1193089/46d3177140c176b460ede1c1ebee4ddb607c645f/gistfile1.java\" style=\"float:right;\">view raw<\/a>\n            <a href=\"https://gist.github.com/1193089#file_gistfile1.java\" style=\"float:right;margin-right:10px;color:#666\">gistfile1.java<\/a>\n            <a href=\"https://gist.github.com/1193089\">This Gist<\/a> brought to you by <a href=\"http://github.com\">GitHub<\/a>.\n          <\/div>\n        <\/div>\n      \n    \n  \n<\/div>\n')
