document.write('<link rel="stylesheet" href="https://gist.github.com/stylesheets/gist/embed.css"/>')





document.write('<div id=\"gist-1193067\" class=\"gist\">\n  \n  \n    \n      \n        \n        \n\n        <div class=\"gist-file\">\n          <div class=\"gist-data gist-syntax\">\n            \n            \n            \n              <div class=\"gist-highlight\"><pre><div class=\'line\' id=\'LC1\'><span class=\"kd\">public<\/span> <span class=\"kd\">class<\/span> <span class=\"nc\">ContentMD5VerifikasjonsFilter<\/span> <span class=\"kd\">implements<\/span> <span class=\"n\">ContainerRequestFilter<\/span> <span class=\"o\">{<\/span><\/div><div class=\'line\' id=\'LC2\'>	<span class=\"nd\">@Override<\/span><\/div><div class=\'line\' id=\'LC3\'>	<span class=\"kd\">public<\/span> <span class=\"n\">ContainerRequest<\/span> <span class=\"nf\">filter<\/span><span class=\"o\">(<\/span><span class=\"kd\">final<\/span> <span class=\"n\">ContainerRequest<\/span> <span class=\"n\">request<\/span><span class=\"o\">)<\/span> <span class=\"o\">{<\/span><\/div><div class=\'line\' id=\'LC4\'>		<span class=\"k\">try<\/span> <span class=\"o\">{<\/span><\/div><div class=\'line\' id=\'LC5\'>			<span class=\"c1\">// Henter ut alle bytes fra requesten (payload)<\/span><\/div><div class=\'line\' id=\'LC6\'>			<span class=\"kt\">byte<\/span><span class=\"o\">[]<\/span> <span class=\"n\">entityBytes<\/span> <span class=\"o\">=<\/span> <span class=\"n\">IOUtils<\/span><span class=\"o\">.<\/span><span class=\"na\">toByteArray<\/span><span class=\"o\">(<\/span><span class=\"n\">request<\/span><span class=\"o\">.<\/span><span class=\"na\">getEntityInputStream<\/span><span class=\"o\">());<\/span> <span class=\"c1\">// Apache commons<\/span><\/div><div class=\'line\' id=\'LC7\'><br/><\/div><div class=\'line\' id=\'LC8\'>			<span class=\"c1\">// Sjekker bare Content-MD5 dersom det er en request med payload<\/span><\/div><div class=\'line\' id=\'LC9\'>			<span class=\"k\">if<\/span> <span class=\"o\">(<\/span><span class=\"n\">entityBytes<\/span><span class=\"o\">.<\/span><span class=\"na\">length<\/span> <span class=\"o\">&gt;<\/span> <span class=\"mi\">0<\/span><span class=\"o\">)<\/span> <span class=\"o\">{<\/span><\/div><div class=\'line\' id=\'LC10\'>				<span class=\"n\">String<\/span> <span class=\"n\">contentMD5Client<\/span> <span class=\"o\">=<\/span> <span class=\"n\">request<\/span><span class=\"o\">.<\/span><span class=\"na\">getHeaderValue<\/span><span class=\"o\">(<\/span><span class=\"s\">&quot;Content-MD5&quot;<\/span><span class=\"o\">);<\/span><\/div><div class=\'line\' id=\'LC11\'><br/><\/div><div class=\'line\' id=\'LC12\'>				<span class=\"c1\">// sjekk at Content-MD5-headeren er satt<\/span><\/div><div class=\'line\' id=\'LC13\'>				<span class=\"k\">if<\/span> <span class=\"o\">(<\/span><span class=\"n\">contentMD5Client<\/span> <span class=\"o\">==<\/span> <span class=\"kc\">null<\/span><span class=\"o\">)<\/span> <span class=\"o\">{<\/span><\/div><div class=\'line\' id=\'LC14\'>					<span class=\"c1\">// Kast feil<\/span><\/div><div class=\'line\' id=\'LC15\'>				<span class=\"o\">}<\/span><\/div><div class=\'line\' id=\'LC16\'><br/><\/div><div class=\'line\' id=\'LC17\'>				<span class=\"c1\">// Sjekk at ContentMD5 stemmer<\/span><\/div><div class=\'line\' id=\'LC18\'>				<span class=\"n\">validateContentMD5Match<\/span><span class=\"o\">(<\/span><span class=\"n\">contentMD5Client<\/span><span class=\"o\">,<\/span> <span class=\"n\">entityBytes<\/span><span class=\"o\">);<\/span> <\/div><div class=\'line\' id=\'LC19\'>			<span class=\"o\">}<\/span><\/div><div class=\'line\' id=\'LC20\'><br/><\/div><div class=\'line\' id=\'LC21\'>			<span class=\"c1\">// Gir tilbake en ny InputStream med samme innhold til requesten<\/span><\/div><div class=\'line\' id=\'LC22\'>			<span class=\"n\">request<\/span><span class=\"o\">.<\/span><span class=\"na\">setEntityInputStream<\/span><span class=\"o\">(<\/span><span class=\"k\">new<\/span> <span class=\"n\">ByteArrayInputStream<\/span><span class=\"o\">(<\/span><span class=\"n\">entityBytes<\/span><span class=\"o\">));<\/span><\/div><div class=\'line\' id=\'LC23\'>			<span class=\"k\">return<\/span> <span class=\"n\">request<\/span><span class=\"o\">;<\/span><\/div><div class=\'line\' id=\'LC24\'><br/><\/div><div class=\'line\' id=\'LC25\'>		<span class=\"o\">}<\/span> <span class=\"k\">catch<\/span> <span class=\"o\">(<\/span><span class=\"n\">IOException<\/span> <span class=\"n\">e<\/span><span class=\"o\">)<\/span> <span class=\"o\">{<\/span><\/div><div class=\'line\' id=\'LC26\'>			<span class=\"c1\">// Kast feil<\/span><\/div><div class=\'line\' id=\'LC27\'>		<span class=\"o\">}<\/span> <span class=\"k\">catch<\/span> <span class=\"o\">(<\/span><span class=\"n\">NoSuchAlgorithmException<\/span> <span class=\"n\">e<\/span><span class=\"o\">)<\/span> <span class=\"o\">{<\/span><\/div><div class=\'line\' id=\'LC28\'>			<span class=\"c1\">// Kast feil<\/span><\/div><div class=\'line\' id=\'LC29\'>		<span class=\"o\">}<\/span><\/div><div class=\'line\' id=\'LC30\'>	<span class=\"o\">}<\/span><\/div><div class=\'line\' id=\'LC31\'><br/><\/div><div class=\'line\' id=\'LC32\'>	<span class=\"kd\">private<\/span> <span class=\"kt\">void<\/span> <span class=\"nf\">validateContentMD5Match<\/span><span class=\"o\">(<\/span><span class=\"kd\">final<\/span> <span class=\"n\">String<\/span> <span class=\"n\">contentMD5Client<\/span><span class=\"o\">,<\/span> <span class=\"kd\">final<\/span> <span class=\"kt\">byte<\/span><span class=\"o\">[]<\/span> <span class=\"n\">entityBytes<\/span><span class=\"o\">)<\/span> <span class=\"kd\">throws<\/span> <span class=\"n\">NoSuchAlgorithmException<\/span> <span class=\"o\">{<\/span><\/div><div class=\'line\' id=\'LC33\'>		<span class=\"c1\">// Lager vår egen Content-MD5 (sjekksum) fra requestens payload<\/span><\/div><div class=\'line\' id=\'LC34\'>		<span class=\"n\">MessageDigest<\/span> <span class=\"n\">digest<\/span> <span class=\"o\">=<\/span> <span class=\"n\">MessageDigest<\/span><span class=\"o\">.<\/span><span class=\"na\">getInstance<\/span><span class=\"o\">(<\/span><span class=\"s\">&quot;MD5&quot;<\/span><span class=\"o\">);<\/span><\/div><div class=\'line\' id=\'LC35\'>		<span class=\"n\">String<\/span> <span class=\"n\">contentMD5Server<\/span> <span class=\"o\">=<\/span> <span class=\"k\">new<\/span> <span class=\"n\">String<\/span><span class=\"o\">(<\/span><span class=\"n\">Base64<\/span><span class=\"o\">.<\/span><span class=\"na\">encodeBase64<\/span><span class=\"o\">(<\/span><span class=\"n\">digest<\/span><span class=\"o\">.<\/span><span class=\"na\">digest<\/span><span class=\"o\">(<\/span><span class=\"n\">entityBytes<\/span><span class=\"o\">)));<\/span> <span class=\"c1\">// apache commons<\/span><\/div><div class=\'line\' id=\'LC36\'><br/><\/div><div class=\'line\' id=\'LC37\'>		<span class=\"c1\">// Sjekker at vår sjekksum matcher den i Content-MD5-headeren<\/span><\/div><div class=\'line\' id=\'LC38\'>		<span class=\"k\">if<\/span> <span class=\"o\">(!<\/span><span class=\"n\">contentMD5Client<\/span><span class=\"o\">.<\/span><span class=\"na\">equals<\/span><span class=\"o\">(<\/span><span class=\"n\">contentMD5Server<\/span><span class=\"o\">))<\/span> <span class=\"o\">{<\/span><\/div><div class=\'line\' id=\'LC39\'>			<span class=\"c1\">// Kast feil<\/span><\/div><div class=\'line\' id=\'LC40\'>		<span class=\"o\">}<\/span><\/div><div class=\'line\' id=\'LC41\'>	<span class=\"o\">}<\/span><\/div><div class=\'line\' id=\'LC42\'><span class=\"o\">}<\/span><\/div><\/pre><\/div>\n            \n          <\/div>\n\n          <div class=\"gist-meta\">\n            <a href=\"https://gist.github.com/raw/1193067/aa3861ac36184a944d1bcbbd1065893fe7fa419b/gistfile1.java\" style=\"float:right;\">view raw<\/a>\n            <a href=\"https://gist.github.com/1193067#file_gistfile1.java\" style=\"float:right;margin-right:10px;color:#666\">gistfile1.java<\/a>\n            <a href=\"https://gist.github.com/1193067\">This Gist<\/a> brought to you by <a href=\"http://github.com\">GitHub<\/a>.\n          <\/div>\n        <\/div>\n      \n    \n  \n<\/div>\n')
